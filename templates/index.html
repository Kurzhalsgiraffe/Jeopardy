<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeopardy Game</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body {
            color: white;
            background-image: url("/static/images/question-mark.png");
        }
        .btn-primary {
            background-color: darkslategrey;
            border: none;
        }
        .question-card {
            cursor: pointer;
        }
        .card {
            background-color: darkslategrey;
            height: 110px; /* Adjust the height as needed */
            width: 200px; /* Adjust the width as needed */
        }
        .card-body {
            padding: 1rem; /* Adjust as needed for spacing */
        }
        .card-title {
            margin-bottom: 0.5rem; /* Adjust as needed for spacing */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 150px; /* Adjust width to fit within the card */
        }
        .category-block {
            width: 100%;
        }
        .team-cards-wrapper {
            text-align: center;
        }
        .team-header {
            display: flex;
            align-items: center;
            justify-content: center; /* Center horizontally */
            gap: 10px; /* Space between h2 and button */
            margin-bottom: 20px; /* Space between header and cards */
        }
        .team-header h2 {
            margin: 0;
        }
        .team-cards-container {
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            flex-wrap: wrap;
            gap: 20px; /* Space between team cards */
        }
        .team-card {
            position: relative;
            height: auto; /* Adjust the height as needed */
            width: 100%; /* Use full width within the grid column */
            margin-bottom: 10px; /* Space between team cards */
        }
        .team-card:not(.active) {
            display: none;
        }
        .team-card-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remove-team-btn {
            position: absolute;
            top: -15px;
            right: -13px;
            display: none; /* Initially hidden */
        }
        .team-card-settings {
            display: none;
            justify-content: space-between;
            align-items: center;
        }
        .team-buzzer-id-input {
            border-radius: 5px;
        }
        .team-add-points {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .team-add-points-input {
            width: 70px; /* Adjust the width as needed */
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .team-buzzer-id-input {
            width: 30px;
        }
        .team-control-btn {
            width: 30px; /* Adjust the width as needed */
        }
        .manual-score-change-container {
            display: flex;
            gap: 5px; /* Adjust gap to prevent overlap */
        }
        .modal-dialog {
            max-width: 90%; /* Adjust the maximum width as needed */
            margin: 1.75rem auto; /* Center the modal vertically */
        }
        .modal-content {
            height: 50vh; /* Set the height to 50% of the viewport height */
            overflow-y: auto; /* Enable vertical scrolling if content exceeds modal height */
            background-color: darkslategrey; /* Adjust the background color as needed */
            color: white; /* Adjust the text color as needed */
        }
        .modal-content .close {
            color: white; /* Set the color of the close button to white */
        }
        .modal-body {
            display: flex;
            justify-content: center; /* Horizontally center the content */
            align-items: center; /* Vertically center the content */
            text-align: center; /* Center the text horizontally */
            height: 100%; /* Ensure the modal body takes up the full height */
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header-container {
            width: 30%;
            display: flex;
        }
        .answering-team {
            margin: 0;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between; /* Distribute space between buttons */
            align-items: center; /* Center vertically */
        }
        .answered {
            opacity: 0.5;
        }
        .answer-text-container {
            width: 80%;
            text-align: center;
        }
        .answer-button-container {
            width: 7.5%;
            display: flex;
            justify-content: center; /* Horizontally centers the button */
        }
        .answer-button {
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .answer-button:active {
            background-color: #0056b3; /* Change to your desired active background color */
            transform: scale(0.55); /* Slightly scale down the button */
        }
        .blur-text {
            filter: blur(5px); /* Initial blur effect */
            transition: filter 0.5s ease; /* Smooth transition */
            cursor: pointer; /* Change cursor to pointer when hovered */
        }
        .blur-text:hover {
            filter: none; /* Remove blur effect on hover */
        }
        .btn-icon {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: darkslategrey;
        }
        /* Hide up-down arrows for input*/
        /* Chrome, Safari, Edge, Opera */
        .team-buzzer-id-input::-webkit-outer-spin-button,
        .team-buzzer-id-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Firefox */
        .team-buzzer-id-input {
            -moz-appearance: textfield;
            appearance: textfield;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row my-3">
            {% for category in question_matrix %}
                <div class="col-md-2 mx-3">
                    <div class="category-block">
                        <h3>{{ category[0]["category"] }}</h3>
                        <div class="d-flex flex-column">
                            {% for question in category %}
                                <div class="card question-card mb-2 {{ "answered" if question["question_id"] in answered_question_ids }}" data-question-id="{{ question["question_id"] }}"">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ question["points"] }} â‚¬</h5>
                                        <p class="card-text">{{ question["type"] }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="team-cards-wrapper">
                    <div class="team-header">
                        <h2>Teams</h2>
                        <button id="toggle-team-settings-btn" class="btn btn-primary btn-icon">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                    <div class="row team-cards-container">
                        {% for team in teams %}
                        <div>
                            <div class="card team-card {{ 'active' if team.is_active }}" data-team-id="{{ team.team_id }}">
                                <button class="btn btn-sm btn-danger remove-team-btn"><span aria-hidden="true">&times;</span></button>
                                <div class="card-body team-card-body">
                                    <div class="mx-3">
                                        <h5 class="card-title">{{ team.name }}</h5>
                                        <span class="card-text">{{ team.score }}</span>
                                    </div>
                                    <div class="team-add-points mt-2 mx-3">
                                        <input type="number" class="mb-2 team-add-points-input" id="points-{{ team.team_id }}">
                                        <div class="manual-score-change-container">
                                            <button class="btn btn-success btn-sm team-control-btn" data-team-id="{{ team.team_id }}" data-action="add">+</button>
                                            <button class="btn btn-danger btn-sm team-control-btn" data-team-id="{{ team.team_id }}" data-action="subtract">-</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="team-card-settings">
                                    <div class="team-buzzer-id">
                                        <span>Buzzer ID</span>
                                        <input type="number" class="mb-2 team-buzzer-id-input" data-team-id="{{ team.team_id }}" value="{{ team.buzzer_id if team.buzzer_id }}">
                                    </div>
                                    <div class="team-active">
                                        <input type="checkbox" class="team-active-checkbox" data-team-id="{{ team.team_id }}" {{ 'checked' if team.is_active }}>
                                        <span>Active</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <form id="add-teams-form" action="{{ url_for('add_team') }}" method="post" class="mt-4" style="display: none;">
                            <div class="form-group">
                                <label for="name">Team Name</label>
                                <input type="text" class="form-control" id="name" name="name" maxlength="15">
                            </div>
                            <button type="submit" class="btn btn-primary">Add Team</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Modal -->
<div class="modal fade" id="questionModal" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document"> <!-- Change modal-dialog class to modal-xl for extra-large modal -->
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-container">
                    <h5 class="modal-title" id="questionModalLabel"></h5>
                </div>
                <div class="answering-team-container">
                    <h5 class="answering-team" id="questionModalAnsweringTeam"></h5>
                </div>
                <div class="modal-header-container">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
            </div>
            <div class="modal-body">
                <h2 id="questionText"></h2>
            </div>
            <div class="modal-footer">
                <div class="answer-button-container" data-answer="true">
                    <button type="button" class="btn btn-secondary answer-button">Richtig</button>
                </div>
                <div class="answer-text-container">
                    <span id="answerText"></span>
                </div>
                <div class="answer-button-container" data-answer="false">
                    <button type="button" class="btn btn-secondary answer-button">Falsch</button>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        var teamSettingsVisible = false;
        var currentQuestionId;
        var buzzerPollInterval = null;
        var isBuzzerPolling = false;

        $('.modal-footer').on('click', '.answer-button-container', function() {
            const isAnswerCorrect = $(this).attr('data-answer') === 'true';
            submitAnswer(isAnswerCorrect);
        });

        $('.question-card').on('click', function() {
            const questionID = $(this).attr('data-question-id');
            selectQuestion(questionID);
        });

        $('#toggle-team-settings-btn').on('click', function() {
            toggleTeamSettings();
        });

        $('.remove-team-btn').on('click', function() {
            const teamID = $(this).closest('.team-card').data('team-id');
            removeTeam(teamID)
        });

        $('.team-control-btn').on('click', function() {
            const teamID = $(this).data('team-id');
            const action = $(this).data('action');
            updateScore(teamID, action);
        });

        $('.team-buzzer-id-input').on('change', function() {
            const teamID = $(this).data('team-id');
            const newValue = $(this).val();
            updateBuzzerID(teamID, newValue);
        });

        $('.team-active-checkbox').on('change', function() {
            const teamID = $(this).data('team-id');
            const isChecked = $(this).is(':checked');
            toggleTeamActivation(teamID, isChecked);
        });

        $('#add-teams-form').on('submit', function(event) {
            var teamName = $('#name').val().trim();
            if (teamName === '') {
                alert('Team Name cannot be empty.');
                event.preventDefault();
            }
        });

        function start_buzzer_polling(stopConditionCallback) {
            if (!isBuzzerPolling) {
                isBuzzerPolling = true;
                buzzerPollInterval = setInterval(function() {
                    $.ajax({
                        url: '/get_last_buzzer_event',
                        type: 'GET',
                        dataType: 'json',
                        success: function(response) {
                            stopConditionCallback(response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error polling for buzzer event:', error);
                            // Optionally handle error cases
                        }
                    });
                }, 200); // Poll every 200 milliseconds (5 times per second)
            }
        }

        function stop_buzzer_polling() {
            if (isBuzzerPolling) {
                clearInterval(buzzerPollInterval);
                isBuzzerPolling = false;
            }
        }

        function selectQuestion(questionId) {
            currentQuestionId = questionId;

            // Check if the question card is already answered
            var card = $(`[data-question-id="${questionId}"]`);
            var alreadyAnswered = card.hasClass('answered');

            start_buzzer_polling(function(response) {
                var buzzer_id = response.buzzer_id;
                var team_id = response.team_id;
                var team_name = response.team_name;

                $('#questionModalAnsweringTeam').text("Selected Team:");

                if (buzzer_id !== null && team_id !== null) {
                    console.log('Buzzer event received:', response);
                    $('#questionModalAnsweringTeam').text("Selected Team: " + team_name);
                    stop_buzzer_polling();
                }
            })

            $.post("/select_question/" + questionId, {}, function(data) {
                $('#questionModalLabel').text(data.category + " - " + data.points + " (" + data.type + ")")
                $('#questionText').text(data.question);
                $('#answerText').text(data.answer);

                // Show modal without buttons if already answered
                if (alreadyAnswered) {
                    $('.answer-text-container').removeClass('blur-text')
                    $('.answer-button').hide();
                } else {
                    $('.answer-text-container').addClass('blur-text')
                    $('.answer-button').show();
                }

                $('#questionModal').modal('show');
            });
        }

        function updateScore(teamId, action) {
            var pointsInput = document.getElementById('points-' + teamId);
            var points = parseInt(pointsInput.value);

            if (isNaN(points) || points <= 0) {
                alert("Please enter a valid number of points.");
                return;
            }

            var score_delta = action === 'add' ? + points : - points;
            $.post("/update_score", { team_id: teamId, score_delta: score_delta }, function(response) {
                updateTeamScores(response);
            });
        }

        function submitAnswer(is_answer_correct) {
            $.post("/answer_question/" + currentQuestionId, { is_answer_correct: is_answer_correct }, function(response) {
                if (response.success) {
                    if (is_answer_correct) {
                        var card = document.querySelector(`[data-question-id="${currentQuestionId}"]`);
                        card.classList.add('answered');
                        card.style.opacity = '0.5';
                        $('#questionModal').modal('hide');
                    } else {
                        $('#questionModal').modal('show');
                        start_buzzer_polling(function(response) {
                            var buzzer_id = response.buzzer_id;
                            var team_id = response.team_id;
                            var team_name = response.team_name;
                            $('#questionModalAnsweringTeam').text("Selected Team:");

                            if (buzzer_id !== null && team_id !== null) {
                                console.log('Buzzer event received:', response);
                                $('#questionModalAnsweringTeam').text("Selected Team: " + team_name);
                                stop_buzzer_polling();
                            }
                        })
                    }
                    updateTeamScores(response.teams);
                } else {
                    alert(response.message)
                }
            });
        }

        function updateTeamScores(teams) {
            teams.forEach(team => {
                var teamElement = $(`[data-team-id="${team.team_id}"] .card-text`);
                if (teamElement.length > 0) {
                    teamElement.text(team.score);
                }
            });
        }

        function removeTeam(teamId) {
            if (confirm("Are you sure you want to remove this team?")) {
                $.post("/remove_team", { team_id: teamId }, function() {
                    location.reload();
                });
            }
        }

        function toggleTeamActivation(teamId, isChecked) {
            $.post("/toggle_team_activation", { team_id: teamId, active: isChecked }, function(response) {
                var teamCard = $('.team-card[data-team-id="' + teamId + '"]');
                if (isChecked) {
                    teamCard.addClass('active');
                } else {
                    teamCard.removeClass('active');
                }
            });
        }

        function updateBuzzerID(teamId, buzzerId) {
            $.post("/update_buzzer_id", { team_id: teamId, buzzer_id: buzzerId }, function(response) {
                if (response.success) {
                    response.teams.forEach(function(team) {
                        var inputElement = $('.team-buzzer-id-input[data-team-id="' + team.team_id + '"]');
                        if (inputElement.length) {
                            inputElement.val(team.buzzer_id);
                            inputElement.css('background-color', 'lime');
                            setTimeout(function() {
                                inputElement.css('background-color', '');
                            }, 800);
                        }
                    });
                } else {
                    alert(response.message)
                }
            });
        }

        function toggleTeamSettings() {
            var addTeamsForm = $('#add-teams-form');
            var teamCards = $('.team-card');
            var teamCardSettings = $(teamCards).find('.team-card-settings');
            var removeTeamButtons = $(teamCards).find('.remove-team-btn');

            if (!teamSettingsVisible) {
                teamSettingsVisible = true;
                addTeamsForm.show();
                removeTeamButtons.show();
                teamCardSettings.show();
                teamCards.show();
            } else {
                teamSettingsVisible = false;
                addTeamsForm.hide();
                removeTeamButtons.hide();
                teamCardSettings.hide();
                $('.team-card:not(.active)').hide();
            }
        }
    </script>
</body>
</html>
